<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cartón de Bingo</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="manifest" href="/manifest.json" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
</head>
<body>
  <aside class="left-menu">
    <h1>Bingo</h1>
    <div class="menu-controls">
      <div class="color-selector" id="colorSelector">
        <div class="color" style="background-image: linear-gradient(to right, #ff6600, #ff9933);" data-color-primary="#ff6600" data-color-secondary="#ff9933" data-color-background="#fff4dc"></div>
        <div class="color" style="background-image: linear-gradient(to right, #4CAF50, #8BC34A);" data-color-primary="#4CAF50" data-color-secondary="#8BC34A" data-color-background="#E8F5E9"></div>
        <div class="color" style="background-image: linear-gradient(to right, #2196F3, #64B5F6);" data-color-primary="#2196F3" data-color-secondary="#64B5F6" data-color-background="#E3F2FD"></div>
        <div class="color" style="background-image: linear-gradient(to right, #9C27B0, #BA68C8);" data-color-primary="#9C27B0" data-color-secondary="#BA68C8" data-color-background="#F3E5F5"></div>
        <div class="color" style="background-image: linear-gradient(to right, #FFC107, #FFD54F);" data-color-primary="#FFC107" data-color-secondary="#FFD54F" data-color-background="#FFF8E1"></div>
        
        <div class="color" style="background-image: linear-gradient(to right, #E91E63, #F48FB1);" data-color-primary="#E91E63" data-color-secondary="#F48FB1" data-color-background="#FCE4EC"></div>
        <div class="color" style="background-image: linear-gradient(to right, #009688, #4DB6AC);" data-color-primary="#009688" data-color-secondary="#4DB6AC" data-color-background="#E0F2F1"></div>
        <div class="color" style="background-image: linear-gradient(to right, #3F51B5, #7986CB);" data-color-primary="#3F51B5" data-color-secondary="#7986CB" data-color-background="#E8EAF6"></div>
        <div class="color" style="background-image: linear-gradient(to right, #795548, #A1887F);" data-color-primary="#795548" data-color-secondary="#A1887F" data-color-background="#EFEBE9"></div>
        <div class="color" style="background-image: linear-gradient(to right, #607D8B, #90A4AE);" data-color-primary="#607D8B" data-color-secondary="#90A4AE" data-color-background="#ECEFF1"></div>
      </div>
      <button onclick="generarCarton()" class="refresh-button" title="Reiniciar Cartón">&#x21BB;</button>
      </div>
  </aside>

  <main class="main-content">
    <div class="bingo-card" id="bingo"></div>
  </main>

  <div id="customConfirmModal" class="modal-overlay">
    <div class="modal-content">
      <h2>Generar Nuevo Cartón</h2>
      <p>¿Estás seguro de que quieres generar un nuevo cartón? Se perderá el progreso actual.</p>
      <div class="modal-buttons">
        <button id="modalConfirmYes">Sí</button>
        <button id="modalConfirmNo">No</button>
      </div>
    </div>
  </div>

  <script>
    const patronesValidos = [
      // cada sub-array representa una fila de 9 columnas (true=número, false=vacío)
      // se garantiza que haya 5 números por fila y 1+ por decena
      [
        [true, false, true, false, true, false, true, false, true],
        [true, true, false, true, false, true, false, true, false],
        [false, true, true, false, true, true, false, false, true]
      ],
      [
        [true, true, false, false, true, true, false, false, true],
        [false, false, true, true, false, false, true, true, true],
        [true, false, true, true, false, false, true, true, false]
      ]
      // Se pueden agregar más patrones reales extraídos del PDF si querés variedad
    ];

    let lineAnimationTriggeredThisGame = false; // Controla que la animación de línea se dispare una sola vez por juego

    // Referencias a los elementos del modal
    const customConfirmModal = document.getElementById('customConfirmModal');
    const modalConfirmYes = document.getElementById('modalConfirmYes');
    const modalConfirmNo = document.getElementById('modalConfirmNo');
    let confirmCallback = null; // Para guardar la función de callback de la confirmación

    function getUniqueRandomNumbers(count, min, max, exclude = []) {
      const set = new Set(exclude);
      const result = [];
      while (result.length < count) {
        const n = Math.floor(Math.random() * (max - min + 1)) + min;
        if (!set.has(n)) {
          result.push(n);
          set.add(n);
        }
      }
      return Array.from(result).sort((a, b) => a - b);
    }

    // Nueva función para mostrar el modal personalizado
    function showCustomConfirm(message, callback) {
      document.querySelector('#customConfirmModal p').textContent = message;
      confirmCallback = callback;
      customConfirmModal.classList.add('visible'); // Muestra el modal
    }

    // Nueva función para ocultar el modal
    function hideCustomConfirm() {
      customConfirmModal.classList.remove('visible'); // Oculta el modal
      confirmCallback = null;
    }

    // Modificación de la función generarCarton()
    function generarCarton() {
      const contenedor = document.getElementById("bingo");
      if (contenedor.children.length > 0) {
        // Si ya hay un cartón, muestra el modal personalizado
        showCustomConfirm("¿Estás seguro de que quieres generar un nuevo cartón? Se perderá el progreso actual.", (confirmed) => {
          if (confirmed) {
            // Si el usuario confirma, procede a generar el cartón
            doGenerarCarton();
          }
          hideCustomConfirm(); // Oculta el modal después de la decisión
        });
      } else {
        // Si no hay cartón, genera uno directamente
        doGenerarCarton();
      }
    }

    // Función que realmente genera el cartón, separada para ser llamada desde el modal
    function doGenerarCarton() {
      const contenedor = document.getElementById("bingo");
      contenedor.innerHTML = "";
      contenedor.classList.remove('bingo-won'); // Remove bingo-won class on new game
      lineAnimationTriggeredThisGame = false; // Resetear la variable al generar un nuevo cartón

      const pattern = patronesValidos[Math.floor(Math.random() * patronesValidos.length)];
      const columnas = Array.from({ length: 9 }, (_, i) => {
        const min = i === 0 ? 1 : i * 10;
        const max = i === 8 ? 90 : i * 10 + 9;
        const cantidad = pattern.reduce((acc, fila) => acc + (fila[i] ? 1 : 0), 0);
        return getUniqueRandomNumbers(cantidad, min, max);
      });

      const matriz = pattern.map((fila, filaIdx) =>
        fila.map((celda, colIdx) => {
          if (celda) return columnas[colIdx].shift();
          return null;
        })
      );

      for (let fila = 0; fila < 3; fila++) {
        for (let col = 0; col < 9; col++) {
          const celda = document.createElement("div");
          const num = matriz[fila][col];
          if (num !== null) {
            celda.className = "cell";
            // Envuelve el número en un <span> para control de estilo más preciso
            const span = document.createElement("span");
            span.textContent = String(num).padStart(2, '0'); 
            celda.appendChild(span);

            celda.dataset.row = fila; // Store row for easy access
            celda.dataset.col = col; // Store column for easy access
            celda.onclick = () => {
              celda.classList.toggle("marked");
              checkGameStatus(); // Check for lines/bingo after each click
            };
          } else {
            celda.className = "cell empty";
          }
          contenedor.appendChild(celda);
        }
      }
    }

    function checkGameStatus() {
      const allCells = Array.from(document.querySelectorAll('.bingo-card .cell:not(.empty)'));
      const markedCells = Array.from(document.querySelectorAll('.bingo-card .cell.marked'));
      const bingoCard = document.getElementById('bingo');

      // Remover cualquier animación de bingo previa para evitar conflictos visuales
      bingoCard.classList.remove('bingo-won');

      // Check for Bingo
      if (markedCells.length === allCells.length && allCells.length > 0) {
        bingoCard.classList.add('bingo-won');
        // No alert, solo la animación
        return; // No need to check for lines if Bingo is achieved
      }

      // Check for Lines
      const cells = document.querySelectorAll('.bingo-card .cell:not(.empty)');
      const grid = Array.from({ length: 3 }, () => Array(9).fill(null));

      cells.forEach(cell => {
        const row = parseInt(cell.dataset.row);
        const col = parseInt(cell.dataset.col);
        grid[row][col] = cell.classList.contains('marked');
      });

      let lineFoundThisCheck = false;
      // Check horizontal lines
      for (let r = 0; r < 3; r++) {
        let cellsInRow = 0;
        let markedInRow = 0;
        for (let c = 0; c < 9; c++) {
          const cell = document.querySelector(`.cell[data-row="${r}"][data-col="${c}"]`);
          if (cell && !cell.classList.contains('empty')) {
            cellsInRow++;
            if (grid[r][c]) {
              markedInRow++;
            }
          }
        }
        if (cellsInRow > 0 && markedInRow === cellsInRow && markedInRow === 5) { // Only 5 cells per line for a valid bingo row
          lineFoundThisCheck = true; // Se encontró al menos una línea
          break; // Si encontramos una línea, salimos del bucle para no re-triggerear innecesariamente
        }
      }

      if (lineFoundThisCheck && !lineAnimationTriggeredThisGame) {
        bingoCard.classList.add('bingo-won'); // Usa la misma animación del bingo
        lineAnimationTriggeredThisGame = true; // Marcar que la animación de línea ya se activó
        // Remover la animación después de que termine para que pueda re-activarse en un futuro bingo
        bingoCard.addEventListener('animationend', () => {
            bingoCard.classList.remove('bingo-won');
        }, { once: true });
      }
    }

    // Color Theme Logic
    const colorSelector = document.getElementById('colorSelector');
    colorSelector.addEventListener('click', (event) => {
      const target = event.target;
      if (target.classList.contains('color')) {
        const primaryColor = target.dataset.colorPrimary;
        const secondaryColor = target.dataset.colorSecondary;
        const backgroundColor = target.dataset.colorBackground;

        document.documentElement.style.setProperty('--primary-color', primaryColor);
        document.documentElement.style.setProperty('--secondary-color', secondaryColor);
        document.documentElement.style.setProperty('--background-cell-color', backgroundColor);
      }
    });

    window.onload = () => {
      // Set default colors on load (first color in the selector)
      const defaultColorDiv = document.querySelector('.color-selector .color');
      if (defaultColorDiv) {
        document.documentElement.style.setProperty('--primary-color', defaultColorDiv.dataset.colorPrimary);
        document.documentElement.style.setProperty('--secondary-color', defaultColorDiv.dataset.colorSecondary);
        document.documentElement.style.setProperty('--background-cell-color', defaultColorDiv.dataset.colorBackground);
      }
      doGenerarCarton(); // Llamar a doGenerarCarton directamente para el inicio
    };

    // Event listeners para los botones del modal
    modalConfirmYes.addEventListener('click', () => {
      if (confirmCallback) {
        confirmCallback(true); // Pasar 'true' para confirmar
      }
    });

    modalConfirmNo.addEventListener('click', () => {
      if (confirmCallback) {
        confirmCallback(false); // Pasar 'false' para cancelar
      }
    });
  </script>
</body>
</html>
